<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì²­ - í”„ë¡œí•„</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- Auth Page (Login/Signup) -->
    <div id="authContainer" class="auth-wrapper">
        <div class="auth-box">
            <h1 class="logo">chog</h1>
            <p class="auth-desc">ì²­ì˜ ê³µê°„ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</p>

            <div class="auth-tabs">
                <button class="active" onclick="showLogin()">ë¡œê·¸ì¸</button>
                <button onclick="showSignup()">íšŒì›ê°€ì…</button>
            </div>

            <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼" required>
                <input type="password" id="loginPassword" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                <button type="submit" class="btn-submit">ì…ì¥í•˜ê¸°</button>
            </form>

            <form id="signupForm" class="auth-form hidden" onsubmit="handleSignup(event)">
                <input type="text" id="signupName" placeholder="ì´ë¦„ (ë‹‰ë„¤ì„)" required>
                <input type="email" id="signupEmail" placeholder="ì´ë©”ì¼" required>
                <input type="password" id="signupPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)" required minlength="6">
                <button type="submit" class="btn-submit">ê°€ì…í•˜ê¸°</button>
            </form>
            <p id="authError" class="error-msg"></p>
        </div>
    </div>

    <!-- Main Page (Profile + SNS) -->
    <div id="mainContainer" class="main-wrapper hidden">
        <!-- 1. Original Profile Section -->
        <section class="profile-section">
            <div class="profile-card-glass">
                <div class="profile-top">
                    <img src="assets/profile.png" alt="í”„ë¡œí•„" id="mainProfileImg" class="profile-img">
                    <div class="profile-info">
                        <h1 id="mainUserName">ì²­</h1>
                        <p id="mainUserBio">ë°˜ê°‘ìŠµë‹ˆë‹¤! 'ì²­'ì…ë‹ˆë‹¤.</p>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-icon" onclick="toggleGallery()">
                        <span>ğŸŒŠ</span>
                    </button>
                    <button class="btn-icon" onclick="alert('ë°”ë³´')">
                        <span>ğŸ’™</span>
                    </button>
                </div>

                <div class="user-controls">
                    <button onclick="toggleEditProfile()" class="text-btn">ì •ë³´ ìˆ˜ì •</button>
                    <span class="divider">|</span>
                    <button onclick="handleLogout()" class="text-btn logout">ë¡œê·¸ì•„ì›ƒ</button>
                </div>
            </div>
        </section>

        <!-- 2. SNS Feed Section -->
        <section class="feed-section">
            <div class="write-card">
                <textarea id="postContent" placeholder="ë°©ëª…ë¡ì„ ë‚¨ê²¨ì£¼ì„¸ìš”..."></textarea>
                <div class="write-bottom">
                    <input type="text" id="postImgUrl" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ)">
                    <button onclick="createPost()" class="btn-post">ë‚¨ê¸°ê¸°</button>
                </div>
            </div>

            <div id="postsList" class="posts-stream">
                <div class="loading">ë¡œë”© ì¤‘...</div>
            </div>
        </section>
    </div>

    <!-- Gallery Modal (Original) -->
    <div id="galleryModal" class="modal">
        <div class="modal-header">
            <h2>ë¯¸ë””ì–´ ê°¤ëŸ¬ë¦¬</h2>
            <button class="close-btn" onclick="toggleGallery()">&times;</button>
        </div>
        <div class="modal-content gallery-grid">
            <div class="grid-item"><img src="assets/gallery1.png" onclick="openLightbox(this.src)"></div>
            <div class="grid-item"><img src="assets/gallery2.png" onclick="openLightbox(this.src)"></div>
            <div class="grid-item"><img src="assets/gallery3.jpg" onclick="openLightbox(this.src)"></div>
            <div class="grid-item"><img src="assets/gallery4.jpg" onclick="openLightbox(this.src)"></div>
        </div>
    </div>

    <!-- Profile Edit Modal -->
    <div id="editProfileModal" class="modal-overlay hidden">
        <div class="modal-box">
            <h3>ë‚´ ì •ë³´ ìˆ˜ì •</h3>
            <input type="text" id="editNameInput" placeholder="ì´ë¦„">
            <input type="text" id="editBioInput" placeholder="í•œì¤„ ì†Œê°œ (ì•„ì§ ê¸°ëŠ¥ ì¤€ë¹„ì¤‘)" disabled style="background:#eee">
            <input type="text" id="editImgInput" placeholder="í”„ë¡œí•„ ì´ë¯¸ì§€ URL">
            <div class="modal-actions">
                <button onclick="saveProfile()" class="btn-primary">ì €ì¥</button>
                <button onclick="toggleEditProfile()" class="btn-secondary">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <!-- Lightbox -->
    <div id="lightboxModal" class="lightbox" onclick="closeLightbox()">
        <img id="lightboxImg" src="" alt="Enlarged">
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLxXjUFBcWfAwyQQz4hW2-mAI3YD3W4Rs",
            authDomain: "chog-49654.firebaseapp.com",
            projectId: "chog-49654",
            storageBucket: "chog-49654.firebasestorage.app",
            messagingSenderId: "360507471223",
            appId: "1:360507471223:web:5590b7c950ad6b3c5d5d72",
            measurementId: "G-LT0NQXPZJ0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authContainer').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                updateProfileUI(user);
                loadPosts();
            } else {
                currentUser = null;
                document.getElementById('authContainer').classList.remove('hidden');
                document.getElementById('mainContainer').classList.add('hidden');
            }
        });

        // Gallery & UI Functions
        window.toggleGallery = () => {
            const modal = document.getElementById('galleryModal');
            modal.style.display = (modal.style.display === 'flex') ? 'none' : 'flex';
        };

        window.openLightbox = (src) => {
            document.getElementById('lightboxImg').src = src;
            document.getElementById('lightboxModal').style.display = 'flex';
        };

        window.closeLightbox = () => {
            document.getElementById('lightboxModal').style.display = 'none';
        }

        window.showLogin = () => {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.querySelectorAll('.auth-tabs button')[0].classList.add('active');
            document.querySelectorAll('.auth-tabs button')[1].classList.remove('active');
        };

        window.showSignup = () => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.querySelectorAll('.auth-tabs button')[0].classList.remove('active');
            document.querySelectorAll('.auth-tabs button')[1].classList.add('active');
        };

        window.toggleEditProfile = () => {
            const modal = document.getElementById('editProfileModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                const user = auth.currentUser;
                document.getElementById('editNameInput').value = user.displayName || '';
                document.getElementById('editImgInput').value = user.photoURL || '';
            } else {
                modal.classList.add('hidden');
            }
        };

        // Auth Logic
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('authError').innerText = "ì˜¤ë¥˜: " + error.message;
            }
        };

        window.handleSignup = async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            try {
                const cred = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(cred.user, { displayName: name, photoURL: "assets/profile.png" });
                location.reload();
            } catch (error) {
                document.getElementById('authError').innerText = "ì˜¤ë¥˜: " + error.message;
            }
        };

        window.handleLogout = () => signOut(auth);

        window.saveProfile = async () => {
            const newName = document.getElementById('editNameInput').value;
            const newImg = document.getElementById('editImgInput').value;
            try {
                await updateProfile(auth.currentUser, { displayName: newName, photoURL: newImg || "assets/profile.png" });
                updateProfileUI(auth.currentUser);
                toggleEditProfile();
                alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
                alert('ì‹¤íŒ¨: ' + e.message);
            }
        };

        function updateProfileUI(user) {
            // ì´ ì•±ì˜ ì£¼ì¸ì€ 'ì²­'ì´ë¯€ë¡œ ë©”ì¸ í”„ë¡œí•„ì€ ê³ ì •ëœ 'ì²­'ì¼ ìˆ˜ë„ ìˆê³ , ë¡œê·¸ì¸í•œ ì‚¬ëŒì¼ ìˆ˜ë„ ìˆìŒ.
            // ê¸°íš ì˜ë„: 'ì²­'ì˜ í˜ì´ì§€ ë°©ë¬¸ -> ë¡œê·¸ì¸(ë°©ëª…ë¡ ì“°ê¸° ìœ„í•¨) -> ë‚´ ì •ë³´ê°€ ì•„ë‹ˆë¼ 'ì²­'ì´ ë³´ì—¬ì•¼ í•¨?
            // ì•„ë‹ˆë©´ ë‚´ í”„ë¡œí•„ í˜ì´ì§€ê°€ ë˜ëŠ” ê²ƒì„?
            // "ì²­ - í”„ë¡œí•„" í˜ì´ì§€ì´ë¯€ë¡œ ìƒë‹¨ì€ 'ì²­'ìœ¼ë¡œ ê³ ì •í•˜ê³ ,
            // í•˜ë‹¨ ê¸€ì“°ê¸° ì°½ì´ë‚˜ ëŒ“ê¸€ì—ì„œ ë‚´ í”„ì‚¬ë¥¼ ë³´ì—¬ì£¼ëŠ” ê²Œ ë§ì„ ë“¯ í•˜ì§€ë§Œ,
            // í˜„ì¬ ìš”êµ¬ì‚¬í•­ "í”„ë¡œí•„ì„ ìˆ˜ì •í•˜ê³ " ë¼ê³  í–ˆìœ¼ë¯€ë¡œ ë³¸ì¸ í”„ë¡œí•„ í˜ì´ì§€í™” ë˜ëŠ” ê²ƒìœ¼ë¡œ ê°€ì •.
            if (user.displayName) document.getElementById('mainUserName').innerText = user.displayName;
            if (user.photoURL) document.getElementById('mainProfileImg').src = user.photoURL;
        }

        // SNS Logic
        window.createPost = async () => {
            const content = document.getElementById('postContent').value;
            const imgUrl = document.getElementById('postImgUrl').value;
            if (!content.trim()) return;

            try {
                await addDoc(collection(db, "posts"), {
                    uid: currentUser.uid,
                    author: currentUser.displayName || 'ìµëª…',
                    photo: currentUser.photoURL || 'assets/profile.png',
                    text: content,
                    image: imgUrl,
                    createdAt: serverTimestamp()
                });
                document.getElementById('postContent').value = '';
                document.getElementById('postImgUrl').value = '';
            } catch (e) { console.error(e); alert('ì‘ì„± ì‹¤íŒ¨'); }
        };

        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('postsList');
                list.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const date = data.createdAt ? new Date(data.createdAt.toDate()).toLocaleTimeString() : 'ë°©ê¸ˆ';
                    const div = document.createElement('div');
                    div.className = 'post-item';
                    div.innerHTML = `
                        <div class="post-meta">
                            <img src="${data.photo}" class="post-avatar">
                            <div class="post-info">
                                <b>${data.author}</b>
                                <small>${date}</small>
                            </div>
                        </div>
                        <p class="post-content">${data.text}</p>
                        ${data.image ? `<img src="${data.image}" class="post-img-content">` : ''}
                    `;
                    list.appendChild(div);
                });
            });
        }
    </script>
</body>

</html>