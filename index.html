<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>청 - 프로필</title>
    <link rel="stylesheet" href="style.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;500;700&display=swap" rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Auth Container (Login/Signup) -->
        <div id="authContainer" class="container">
            <h1 class="logo">chog</h1>
            <div class="auth-tabs">
                <button class="active" onclick="showLogin()">로그인</button>
                <button onclick="showSignup()">회원가입</button>
            </div>

            <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                <input type="email" id="loginEmail" placeholder="이메일" required>
                <input type="password" id="loginPassword" placeholder="비밀번호" required>
                <button type="submit" class="btn-primary">로그인</button>
            </form>

            <form id="signupForm" class="auth-form hidden" onsubmit="handleSignup(event)">
                <input type="text" id="signupName" placeholder="이름 (닉네임)" required>
                <input type="email" id="signupEmail" placeholder="이메일" required>
                <input type="password" id="signupPassword" placeholder="비밀번호 (6자 이상)" required minlength="6">
                <button type="submit" class="btn-primary">회원가입</button>
            </form>
            <p id="authError" class="error-msg"></p>
        </div>

        <!-- Main App Container (Hidden by default) -->
        <div id="mainContainer" class="main-layout hidden">
            <!-- Profile Section -->
            <aside class="profile-card">
                <div class="profile-header">
                    <img src="assets/profile.png" alt="Profile" id="userProfileImg" class="profile-img-small">
                    <div>
                        <h2 id="userNameDisplay">청</h2>
                        <span id="userEmailDisplay" class="user-email">@loading...</span>
                    </div>
                </div>
                <button class="btn-edit" onclick="toggleEditProfile()">프로필 수정</button>
                <button class="btn-logout" onclick="handleLogout()">로그아웃</button>
            </aside>

            <!-- Profile Edit Modal -->
            <div id="editProfileModal" class="modal-overlay hidden">
                <div class="modal-box">
                    <h3>프로필 수정</h3>
                    <input type="text" id="editNameInput" placeholder="새로운 이름">
                    <input type="text" id="editImgInput" placeholder="프로필 이미지 URL (선택사항)">
                    <div class="modal-actions">
                        <button onclick="saveProfile()" class="btn-primary">저장</button>
                        <button onclick="toggleEditProfile()" class="btn-secondary">취소</button>
                    </div>
                </div>
            </div>

            <!-- Feed Section -->
            <main class="feed-section">
                <!-- Write Post -->
                <div class="write-post-card">
                    <textarea id="postContent" placeholder="무슨 생각을 하고 계신가요?"></textarea>
                    <div class="write-actions">
                        <input type="text" id="postImgUrl" placeholder="이미지 URL (선택)">
                        <button onclick="createPost()" class="btn-post">게시</button>
                    </div>
                </div>

                <!-- Posts List -->
                <div id="postsList" class="posts-stream">
                    <!-- Posts will be loaded here -->
                    <div class="loading">게시물 불러오는 중...</div>
                </div>
            </main>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBLxXjUFBcWfAwyQQz4hW2-mAI3YD3W4Rs",
            authDomain: "chog-49654.firebaseapp.com",
            projectId: "chog-49654",
            storageBucket: "chog-49654.firebasestorage.app",
            messagingSenderId: "360507471223",
            appId: "1:360507471223:web:5590b7c950ad6b3c5d5d72",
            measurementId: "G-LT0NQXPZJ0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global State
        let currentUser = null;

        // Auth State Listener
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authContainer').classList.add('hidden');
                document.getElementById('mainContainer').classList.remove('hidden');
                updateProfileUI(user);
                loadPosts();
            } else {
                currentUser = null;
                document.getElementById('authContainer').classList.remove('hidden');
                document.getElementById('mainContainer').classList.add('hidden');
            }
        });

        // UI Functions
        window.showLogin = () => {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('signupForm').classList.add('hidden');
            document.querySelectorAll('.auth-tabs button')[0].classList.add('active');
            document.querySelectorAll('.auth-tabs button')[1].classList.remove('active');
        };

        window.showSignup = () => {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
            document.querySelectorAll('.auth-tabs button')[0].classList.remove('active');
            document.querySelectorAll('.auth-tabs button')[1].classList.add('active');
        };

        window.toggleEditProfile = () => {
            const modal = document.getElementById('editProfileModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                document.getElementById('editNameInput').value = currentUser.displayName || '';
                document.getElementById('editImgInput').value = currentUser.photoURL || '';
            } else {
                modal.classList.add('hidden');
            }
        };

        // Auth Actions
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                document.getElementById('authError').innerText = "로그인 실패: " + error.message;
            }
        };

        window.handleSignup = async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(userCredential.user, {
                    displayName: name,
                    photoURL: "assets/profile.png" // default image
                });
                location.reload(); // Refresh to update UI
            } catch (error) {
                document.getElementById('authError').innerText = "가입 실패: " + error.message;
            }
        };

        window.handleLogout = () => signOut(auth);

        window.saveProfile = async () => {
            const newName = document.getElementById('editNameInput').value;
            const newImg = document.getElementById('editImgInput').value;

            try {
                await updateProfile(auth.currentUser, {
                    displayName: newName,
                    photoURL: newImg || currentUser.photoURL
                });
                updateProfileUI(auth.currentUser);
                toggleEditProfile();

                // Update previous posts author name (Optional: complex in NoSQL, skipping for simple demo)
                alert('프로필이 업데이트되었습니다!');
            } catch (e) {
                alert('업데이트 실패: ' + e.message);
            }
        };

        function updateProfileUI(user) {
            document.getElementById('userNameDisplay').innerText = user.displayName || '이름 없음';
            document.getElementById('userEmailDisplay').innerText = user.email;
            if (user.photoURL) document.getElementById('userProfileImg').src = user.photoURL;
        }

        // Post Actions
        window.createPost = async () => {
            const content = document.getElementById('postContent').value;
            const imgUrl = document.getElementById('postImgUrl').value;

            if (!content.trim()) return alert('내용을 입력해주세요!');

            try {
                await addDoc(collection(db, "posts"), {
                    uid: currentUser.uid,
                    authorName: currentUser.displayName,
                    authorPhoto: currentUser.photoURL,
                    content: content,
                    imageUrl: imgUrl,
                    createdAt: serverTimestamp()
                });
                document.getElementById('postContent').value = '';
                document.getElementById('postImgUrl').value = '';
            } catch (e) {
                alert('게시 실패: ' + e.message);
            }
        };

        // Load Posts
        function loadPosts() {
            const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('postsList');
                list.innerHTML = '';
                snapshot.forEach((doc) => {
                    const post = doc.data();
                    const date = post.createdAt ? new Date(post.createdAt.toDate()).toLocaleString() : '방금 전';

                    const postEl = document.createElement('div');
                    postEl.className = 'post-card';
                    postEl.innerHTML = `
                        <div class="post-header">
                            <img src="${post.authorPhoto || 'assets/profile.png'}" class="post-avatar">
                            <div>
                                <strong>${post.authorName}</strong>
                                <span class="post-date">${date}</span>
                            </div>
                        </div>
                        <p class="post-text">${post.content}</p>
                        ${post.imageUrl ? `<img src="${post.imageUrl}" class="post-image">` : ''}
                    `;
                    list.appendChild(postEl);
                });
            });
        }
    </script>
</body>

</html>